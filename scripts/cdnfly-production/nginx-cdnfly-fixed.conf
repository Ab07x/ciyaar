server {
    listen 80;
    server_name origin.cdnfly.online;

    # Root - Using ciyaar directory
    root /home/ubuntu/ciyaar/hls;

    # CORS
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;

    # Enable TCP optimizations for streaming
    tcp_nopush on;
    tcp_nodelay on;
    sendfile on;
    sendfile_max_chunk 512k;

    # M3U8 Playlists - Short cache, must revalidate
    location ~ \.m3u8$ {
        access_log off;
        add_header Cache-Control "public, max-age=1, must-revalidate";
        add_header Access-Control-Allow-Origin * always;
        expires 1s;
        types {
            application/vnd.apple.mpegurl m3u8;
        }
        gzip on;
        gzip_types application/vnd.apple.mpegurl;
    }

    # TS Segments - Longer cache since they're immutable
    location ~ \.ts$ {
        access_log off;
        add_header Cache-Control "public, max-age=30, immutable";
        add_header Access-Control-Allow-Origin * always;
        expires 30s;
        types {
            video/mp2t ts;
        }
        # Enable range requests for seeking
        add_header Accept-Ranges bytes;
    }

    # Status
    location /status {
        return 200 '{"status":"live"}';
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin * always;
    }

    # Health check
    location /health {
        access_log off;
        return 200 'OK';
    }
}
