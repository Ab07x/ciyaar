# ==============================================================================
# OPTIMIZED CONFIGURATION FOR 16GB RAM / 4 vCPU Lightsail Instance
# ==============================================================================
# This configuration maximizes performance for the $84/month Lightsail plan
# Capable of handling 4-6 simultaneous HD sports streams
# ==============================================================================

# ==============================================================================
# SYSTEM OPTIMIZATIONS
# ==============================================================================

# Kernel tuning for high-performance networking
cat >> /etc/sysctl.conf << 'EOF'
# Network performance
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_notsent_lowat = 16384

# File descriptors
fs.file-max = 2097152
fs.nr_open = 2097152

# Memory
vm.swappiness = 10
vm.dirty_ratio = 40
vm.dirty_background_ratio = 10
EOF

# Apply sysctl
sysctl -p

# Increase file descriptor limits
cat >> /etc/security/limits.conf << 'EOF'
* soft nofile 1048576
* hard nofile 1048576
* soft nproc 65536
* hard nproc 65536
EOF

# ==============================================================================
# NGINX OPTIMIZED CONFIG (16GB RAM)
# ==============================================================================

cat > /etc/nginx/nginx.conf << 'EOF'
user www-data;
worker_processes 4;                    # Match vCPU count
worker_rlimit_nofile 1048576;          # High file descriptor limit
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 8192;           # High connection count
    use epoll;
    multi_accept on;
    accept_mutex off;
}

# RTMP Configuration
rtmp {
    server {
        listen 1935;
        chunk_size 8192;               # Larger chunks for efficiency
        
        # Allow publish from localhost and private networks only
        allow publish 127.0.0.1;
        allow publish 10.0.0.0/8;
        allow publish 172.16.0.0/12;
        allow publish 192.168.0.0/16;
        deny publish all;
        
        buflen 1s;
        
        # Application for multiple sports events
        application sports {
            live on;
            
            # HLS with optimized settings for 16GB RAM
            hls on;
            hls_path /var/www/html/sports;
            hls_fragment 2s;                    # Lower latency
            hls_playlist_length 1h;             # 1 hour retention
            hls_continuous on;
            hls_cleanup on;
            hls_nested on;                      # Nested directories per stream
            hls_fragment_naming system;         # Use timestamps
            
            # Multi-quality variants
            hls_variant _low BANDWIDTH=800000 RESOLUTION=640x360;
            hls_variant _mid BANDWIDTH=2000000 RESOLUTION=1280x720;
            hls_variant _high BANDWIDTH=4000000 RESOLUTION=1920x1080;
            
            # Recording for replay
            record all;
            record_path /var/recordings/sports;
            record_unique on;
            record_suffix .flv;
            record_max_size 10G;
            record_max_frames 2;
            record_max_seconds 14400;           # 4 hours max recording
        }
        
        # Stats application
        application stats {
            live on;
            
            # Push to stats collectors if needed
            # push rtmp://monitoring-server/stats;
        }
    }
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Optimized log format with more details
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time" '
                    'sid=$upstream_http_session_id';
    
    access_log /var/log/nginx/access.log main buffer=32k flush=5s;
    
    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 30;
    keepalive_requests 1000;
    types_hash_max_size 2048;
    server_tokens off;
    
    # Gzip for non-streaming content
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript;
    
    # Rate limiting - generous limits for 16GB plan
    limit_req_zone $binary_remote_addr zone=playback:50m rate=30r/s;
    limit_conn_zone $binary_remote_addr zone=addr:50m;
    
    # Cache zone for HLS segments
    proxy_cache_path /var/cache/nginx/hls levels=1:2 keys_zone=hls:100m max_size=10g inactive=60m use_temp_path=off;
    
    # Upstream for auth backend
    upstream auth_backend {
        server 127.0.0.1:3000;
        keepalive 64;
    }
    
    # Server block
    server {
        listen 80;
        listen [::]:80;
        server_name _;
        
        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        root /var/www/html;
        
        # HLS Stream Delivery - Optimized for high concurrency
        location /sports/ {
            # CORS headers
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Range, Origin, X-Requested-With, Content-Type" always;
            
            # Cache control for HLS
            location ~ \.m3u8$ {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Cache-Control "no-cache, no-store, must-revalidate" always;
                add_header Pragma "no-cache" always;
                expires -1;
                
                # Rate limiting for playlist requests
                limit_req zone=playback burst=50 nodelay;
            }
            
            location ~ \.ts$ {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Cache-Control "public, max-age=60" always;
                expires 1m;
                
                # Higher limit for segments
                limit_req zone=playback burst=100 nodelay;
                limit_conn addr 20;
            }
            
            # Serve files
            alias /var/www/html/sports/;
            
            # Handle preflight
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
                add_header Access-Control-Max-Age 86400;
                add_header Content-Length 0;
                return 204;
            }
        }
        
        # RTMP Stats (protected)
        location /stats {
            allow 127.0.0.1;
            allow 10.0.0.0/8;
            allow 172.16.0.0/12;
            allow 192.168.0.0/16;
            deny all;
            
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        
        # Health check
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # Status page
        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }
        
        # Deny hidden files
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
    }
}
EOF

# ==============================================================================
# CREATE SYSTEMD SERVICE FOR MULTI-STREAM MANAGEMENT
# ==============================================================================

cat > /etc/systemd/system/sports-stream-manager.service << 'EOF'
[Unit]
Description=Sports Stream Manager
After=network.target nginx.service
Wants=nginx.service

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/sports-stream
Environment="PATH=/usr/local/bin:/usr/bin:/bin"
Environment="NODE_ENV=production"
ExecStartPre=/bin/sleep 5
ExecStart=/home/ubuntu/sports-stream/scripts/monitor-health.sh start
ExecStop=/home/ubuntu/sports-stream/scripts/monitor-health.sh stop
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Enable service
systemctl daemon-reload
systemctl enable sports-stream-manager

# ==============================================================================
# OPTIMIZED FFMPEG SETTINGS FOR 16GB
# ==============================================================================

cat > ~/sports-stream/config/ffmpeg-16gb.conf << 'EOF'
# FFmpeg optimized settings for 16GB RAM / 4 vCPU instance
# Supports 4-6 simultaneous HD streams

# Memory allocation per FFmpeg process (2GB max each)
FFMPEG_MEMORY_LIMIT="2048M"

# Thread count per stream (leave 1 core for system)
FFMPEG_THREADS=3

# Buffer sizes
FFMPEG_BUFFER_SIZE="128M"

# Maximum simultaneous streams
MAX_CONCURRENT_STREAMS=6

# HLS settings optimized for low latency
HLS_TIME=2
HLS_LIST_SIZE=1800

# Recording settings
RECORD_MAX_SIZE="10G"
RECORD_MAX_DURATION=14400
EOF

# ==============================================================================
# CREATE MULTI-STREAM LAUNCHER
# ==============================================================================

cat > ~/sports-stream/scripts/multi-stream-launcher.sh << 'EOF'
#!/bin/bash
# Launch multiple streams optimized for 16GB instance

CONFIG_DIR="$HOME/sports-stream/config"
source "$CONFIG_DIR/ffmpeg-16gb.conf"

# Check current stream count
current_streams=$(pgrep -c ffmpeg 2>/dev/null || echo 0)

if [ "$current_streams" -ge "$MAX_CONCURRENT_STREAMS" ]; then
    echo "Maximum streams reached ($MAX_CONCURRENT_STREAMS)"
    exit 1
fi

echo "Starting stream $((current_streams + 1)) of $MAX_CONCURRENT_STREAMS"
echo "Available resources: $((16 - current_streams * 2))GB RAM, $((4 - current_streams)) cores"
EOF

chmod +x ~/sports-stream/scripts/multi-stream-launcher.sh

# ==============================================================================
# PERFORMANCE MONITORING ALIASES
# ==============================================================================

cat >> ~/.bashrc << 'EOF'

# 16GB Plan Performance Aliases
alias streams='pgrep -c ffmpeg 2>/dev/null || echo 0'
alias stream-ram='ps aux | grep ffmpeg | grep -v grep | awk "{sum+=\$6} END {print sum/1024/1024 \" GB\"}"'
alias stream-cpu='ps aux | grep ffmpeg | grep -v grep | awk "{sum+=\$3} END {print sum \"%\"}"'
alias nginx-conns='ss -ant | grep :80 | wc -l'
alias bandwidth='vnstat -i eth0 -tr 5 2>/dev/null || echo "Install vnstat"'
alias perf='echo "=== Performance ===" && echo "Streams: $(streams)" && echo "RAM: $(stream-ram)" && echo "CPU: $(stream-cpu)" && echo "Connections: $(nginx-conns)"'
EOF

echo "âœ… 16GB Optimized Configuration Applied!"
echo ""
echo "Capabilities:"
echo "  - Up to 6 simultaneous HD streams"
echo "  - 2GB RAM allocated per FFmpeg process"
echo "  - 3 threads per stream (1 core reserved)"
echo "  - Optimized kernel networking (BBR congestion control)"
echo "  - 6TB monthly transfer capacity"
echo ""
echo "Commands:"
echo "  streams      - Show active stream count"
echo "  stream-ram   - Show FFmpeg memory usage"
echo "  stream-cpu   - Show FFmpeg CPU usage"
echo "  nginx-conns  - Show active connections"
echo "  bandwidth    - Show current bandwidth"
echo "  perf         - Show all performance metrics"
